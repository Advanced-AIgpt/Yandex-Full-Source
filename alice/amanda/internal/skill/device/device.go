package device

import (
	"fmt"
	"regexp"
	"strconv"
	"strings"

	"gopkg.in/tucnak/telebot.v2"

	"a.yandex-team.ru/alice/amanda/internal/app"
	"a.yandex-team.ru/alice/amanda/internal/linker"
	"a.yandex-team.ru/alice/amanda/internal/passport"
	"a.yandex-team.ru/alice/amanda/internal/session"
	"a.yandex-team.ru/alice/amanda/internal/skill/common"
)

const (
	StateUpdatedServerAction = "server_action.device_state_updated"
	_callbackSoundQuieter    = "device.sound.quieter"
	_callbackSoundLouder     = "device.sound.louder"
	_callbackSoundSwitch     = "device.sound.switch"
	_callbackTVSwitch        = "device.tv.switch"
)

func RegistrySkill(c common.Controller, linkerService linker.Service, passportService passport.Service) {
	device := skill{
		linkerService:   linkerService,
		passportService: passportService,
	}
	c.AddCommand(common.NewCommand("device"), device.device)
	c.AddServerAction(common.MakeCommandRegexpFromCallbackString(StateUpdatedServerAction), onStateUpdated)
	c.AddCallback(common.MakeCommandRegexpFromCallbackString(_callbackSoundLouder), device.soundLouder)
	c.AddCallback(common.MakeCommandRegexpFromCallbackString(_callbackSoundQuieter), device.soundQuieter)
	c.AddCallback(common.MakeCommandRegexpFromCallbackString(_callbackSoundSwitch), device.soundSwitch)
	c.AddCallback(common.MakeCommandRegexpFromCallbackString(_callbackTVSwitch), device.tvSwitch)
	c.AddCommand(common.NewCommand("setspotter"), device.setSpotter)
	c.AddCallbackWithArgs(regexp.MustCompile(`^setspotter\.(.+)$`), device.setSpotterCallback)
	c.AddCommand(common.NewCommand("setfiltrationlevel"), device.setFiltrationLevel)
	c.AddCallbackWithArgs(regexp.MustCompile(`^setfiltrationlevel\.(.+)$`), device.setFiltrationLevelCallback)

	c.AddCommand(common.NewCommand("devices"), device.devices)
	c.AddCommand(common.NewCommand("deldevice"), device.delDevice)
	c.AddCallbackWithArgs(regexp.MustCompile(`^devices\.del\.(.+)$`), device.delDeviceCallback)
	common.AddInputStateWithHelpText(c, "adddevice", "–í–≤–µ–¥–∏—Ç–µ DeviceID –∏ –æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ–µ –Ω–∞–∑–≤–∞–Ω–∏–µ —á–µ—Ä–µ–∑ –ø—Ä–æ–±–µ–ª", addDevice)
	c.AddCallback(common.MakeCommandRegexpFromCallbackString("adddevice.addacc"), addDeviceAddAcc)
	c.AddCallbackWithArgs(regexp.MustCompile("^adddevice#(.+)#(.+)$"), device.addDeviceCallback)
	c.AddCallbackWithArgs(regexp.MustCompile(`^device\.select\.(.+)$`), device.deviceSelect)
}

func onStateUpdated(ctx app.Context, action *app.ServerAction) {
	_, _ = ctx.SendMD("*Device State* —É—Å–ø–µ—à–Ω–æ –æ–±–Ω–æ–≤–ª–µ–Ω")
}

type skill struct {
	linkerService   linker.Service
	passportService passport.Service
}

func GetInfo(ctx app.Context) string {
	return strings.Join([]string{
		common.FormatFieldValueMD("–°–ø–æ—Ç—Ç–µ—Ä", getSpotter(ctx)),
		common.FormatFieldValueMD("–¢–µ–ª–µ–≤–∏–∑–æ—Ä", getIsTVPluggedInString(ctx)),
		common.FormatFieldValueMD("–£—Ä–æ–≤–µ–Ω—å –≥—Ä–æ–º–∫–æ—Å—Ç–∏", getSoundLevel(ctx)),
		common.FormatFieldValueMD("–ë–µ–∑–∑–≤—É—á–Ω—ã–π —Ä–µ–∂–∏–º", getSoundMutedString(ctx)),
		common.FormatFieldValueMD("–†–µ–∂–∏–º —Ñ–∏–ª—å—Ç—Ä–∞—Ü–∏–∏ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ –ê–ª–∏—Å—ã", getFiltrationLevel(ctx)),
		common.FormatFieldValueMD("–ü–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞", getDevices(ctx)),
	}, "\n")
}

func getDevices(ctx app.Context) string {
	var devices []string
	for _, device := range ctx.GetSettings().GetSystemDetails().ConnectedDevices {
		devices = append(devices, device.Name)
	}
	return strings.Join(devices, ", ")
}

func getFiltrationLevel(ctx app.Context) string {
	if rawConfig, ok := ctx.GetSettings().GetDeviceState()["device_config"]; ok {
		if config, ok := rawConfig.(map[string]interface{}); ok {
			if rawLevel, ok := config["content_settings"]; ok {
				if level, ok := rawLevel.(string); ok {
					// todo: add title
					return level
				}
			}
		}
	}
	return ""
}

func getIsTVPluggedIn(ctx app.Context) *bool {
	var result *bool
	if raw, ok := ctx.GetSettings().GetDeviceState()["is_tv_plugged_in"]; ok {
		if isTVPluggedIn, ok := raw.(bool); ok {
			result = &isTVPluggedIn
		}
	}
	return result
}

func getIsTVPluggedInString(ctx app.Context) string {
	if isTVPluggedIn := getIsTVPluggedIn(ctx); isTVPluggedIn != nil {
		if *isTVPluggedIn {
			return "–ø–æ–¥–∫–ª—é—á–µ–Ω"
		}
		return "–Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω"
	}
	return ""
}

func getSoundLevel(ctx app.Context) string {
	if raw, ok := ctx.GetSettings().GetDeviceState()["sound_level"]; ok {
		if level, ok := raw.(float64); ok {
			return strconv.Itoa(int(level))
		}
	}
	return ""
}

func getSpotter(ctx app.Context) string {
	if rawConfig, ok := ctx.GetSettings().GetDeviceState()["device_config"]; ok {
		if config, ok := rawConfig.(map[string]interface{}); ok {
			if rawSpotter, ok := config["spotter"]; ok {
				if spotter, ok := rawSpotter.(string); ok {
					// todo: add title
					return spotter
				}
			}
		}
	}
	return ""
}

func getSoundMuted(ctx app.Context) *bool {
	var result *bool
	if raw, ok := ctx.GetSettings().GetDeviceState()["sound_muted"]; ok {
		if muted, ok := raw.(bool); ok {
			result = &muted
		}
	}
	return result
}

func getSoundMutedString(ctx app.Context) string {
	if v := getSoundMuted(ctx); v != nil {
		if *v {
			return "–≤–∫–ª—é—á–µ–Ω"
		}
		return "–≤—ã–∫–ª—é—á–µ–Ω"
	}
	return ""
}

func (s *skill) device(ctx app.Context, msg *telebot.Message) {
	text := strings.Join([]string{
		common.AddHeader(ctx, "–£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ–º", "setspotter", "setfiltrationlevel"),
		GetInfo(ctx),
	}, "\n")
	_, _ = ctx.SendMD(text, &telebot.ReplyMarkup{
		InlineKeyboard: [][]telebot.InlineButton{
			{
				{
					Text: "üîâ",
					Data: _callbackSoundQuieter,
				},
				{
					Text: "üîä",
					Data: _callbackSoundLouder,
				},
				{
					Text: "üîá",
					Data: _callbackSoundSwitch,
				},
			},
			{
				{
					Text: func() string {
						if v := getIsTVPluggedIn(ctx); v == nil || !*v {
							return "–ü–æ–¥–∫–ª—é—á–∏—Ç—å —Ç–µ–ª–µ–≤–∏–∑–æ—Ä"
						}
						return "–û—Ç–∫–ª—é—á–∏—Ç—å —Ç–µ–ª–µ–≤–∏–∑–æ—Ä"
					}(),
					Data: _callbackTVSwitch,
				},
			},
			{
				{
					Text: "–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å",
					URL:  s.linkerService.GetEditDeviceStateURL(ctx.GetSessionID()).String(),
				},
			},
		},
	})
}

func getConnects(ctx app.Context) string {
	devices := ctx.GetSettings().GetSystemDetails().ConnectedDevices
	if devices == nil {
		return "–ù–µ—Ç –ø–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã—Ö —É—Å—Ç—Ä–æ–π—Å—Ç–≤"
	}
	msg := "–ê–∫—Ç–∏–≤–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –Ω–µ –≤—ã–±—Ä–∞–Ω–æ"
	for _, device := range devices {
		if device.IsActive {
			msg = common.FormatFieldValueMD("–ê–∫—Ç–∏–≤–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ", func() string {
				if device.Name == device.UserID {
					return device.Name
				}
				return fmt.Sprintf("%s: %s", device.Name, device.ID)
			}())
		}
	}
	return msg
}

func (s *skill) devices(ctx app.Context, msg *telebot.Message) {
	response := []string{
		common.AddHeader(ctx, "–ü–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞", "adddevice", "deldevice"),
		getConnects(ctx),
	}
	devices := ctx.GetSettings().GetSystemDetails().ConnectedDevices
	var buttons []telebot.InlineButton
	for _, device := range devices {
		if device.IsActive {
			continue
		}
		buttons = append(buttons, telebot.InlineButton{
			Text: device.Name,
			Data: fmt.Sprintf("device.select.%s", device.ID),
		})
	}
	_, _ = ctx.SendMD(strings.Join(response, "\n"), &telebot.ReplyMarkup{
		InlineKeyboard: common.FormatInlineButtons(buttons, 1),
	})
}

func addDeviceAddAcc(ctx app.Context, cb *telebot.Callback) {
	_ = ctx.Delete(cb.Message)
	_, _ = ctx.SendMD("–î–æ–±–∞–≤—å—Ç–µ –Ω—É–∂–Ω—ã–π –∞–∫–∫–∞—É–Ω—Ç —Å –ø–æ–º–æ—â—å—é –∫–æ–º–∞–Ω–¥—ã /addacc –∏ –ø–æ–≤—Ç–æ—Ä–∏—Ç–µ –ø—Ä–æ—Ü–µ–¥—É—Ä—É")
}

func addDevice(ctx app.Context, msg *telebot.Message, arg string) {
	if len(ctx.GetSettings().GetAccountDetails().GetAccounts()) == 0 {
		_, _ = ctx.SendMD("–ü–µ—Ä–µ–¥ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ–º —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –Ω–µ–æ–±—Ö–æ–º–æ –¥–æ–±–∞–≤–∏—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω –∞–∫–∫–∞—É–Ω—Ç\n/addacc")
		return
	}
	var buttons []telebot.InlineButton
	for _, acc := range ctx.GetSettings().GetAccountDetails().GetAccounts() {
		buttons = append(buttons, telebot.InlineButton{
			Text: acc.Username,
			Data: fmt.Sprintf("adddevice#%s#%s", acc.Username, arg),
		})
	}
	buttons = append(buttons, telebot.InlineButton{
		Text: "–ù–µ—Ç –Ω—É–∂–Ω–æ–≥–æ –∞–∫–∫–∞—É–Ω—Ç–∞",
		Data: "adddevice.addacc",
	})
	_, _ = ctx.SendMD("–° –∫–∞–∫–∏–º –∞–∫–∫–∞—É–Ω—Ç–æ–º —Å–≤—è–∑–∞–Ω–æ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ?", &telebot.ReplyMarkup{
		InlineKeyboard: common.FormatInlineButtons(buttons, 1),
	})
}

func (s *skill) getUserID(ctx app.Context, username string) (string, error) {
	for _, acc := range ctx.GetSettings().GetAccountDetails().GetAccounts() {
		if acc.Username == username {
			return s.passportService.GetUserID(acc.OAuthToken)
		}
	}
	return "", fmt.Errorf("account not found")
}

func (s *skill) addDeviceCallback(ctx app.Context, cb *telebot.Callback, args []string) {
	username := args[0]
	deviceInfo := strings.SplitN(args[1], " ", 2)
	device := session.Device{
		ID: deviceInfo[0],
	}
	if len(deviceInfo) == 1 {
		device.Name = device.ID
	} else {
		device.Name = deviceInfo[1]
	}
	userID, err := s.getUserID(ctx, username)
	if err != nil {
		ctx.Logger().Errorf("failed to add device: %w", err)
		_, _ = ctx.SendMD(fmt.Sprintf("–í–æ–∑–Ω–∏–∫–ª–∞ –æ—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–∏ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞: %s", err))
	}
	device.UserID = userID
	ctx.GetSettings().GetSystemDetails().ConnectedDevices = append(ctx.GetSettings().GetSystemDetails().ConnectedDevices, device)
	_, _ = ctx.SendMD("–£—Å—Ç—Ä–æ–π—Å—Ç–≤–æ —É—Å–ø–µ—à–Ω–æ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ")
}

func (s *skill) deviceSelect(ctx app.Context, cb *telebot.Callback, args []string) {
	_ = ctx.Delete(cb.Message)
	id := args[0]
	ok := false
	for i, device := range ctx.GetSettings().GetSystemDetails().ConnectedDevices {
		if device.ID == id {
			ctx.GetSettings().GetSystemDetails().ConnectedDevices[i].IsActive = true
			ok = true
		} else {
			ctx.GetSettings().GetSystemDetails().ConnectedDevices[i].IsActive = false
		}
	}
	if ok {
		s.devices(ctx, cb.Message)
	} else {
		_, _ = ctx.SendMD("–ù–µ –ø–æ–ª—É—á–∏–ª–æ—Å—å —Å–¥–µ–ª–∞—Ç—å –¥–∞–Ω–Ω–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ –∞–∫—Ç–∏–≤–Ω—ã–º")
	}
}

func (s *skill) delDevice(ctx app.Context, msg *telebot.Message) {
	devices := ctx.GetSettings().GetSystemDetails().ConnectedDevices
	if len(devices) == 0 {
		_, _ = ctx.SendMD("–ü–æ–¥–∫–ª—é—á–µ–Ω–Ω—ã–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã\n/devices")
		return
	}
	var buttons []telebot.InlineButton
	for _, device := range ctx.GetSettings().GetSystemDetails().ConnectedDevices {
		buttons = append(buttons, telebot.InlineButton{
			Text: device.Name,
			Data: fmt.Sprintf("devices.del.%s", device.ID),
		})
	}
	_, _ = ctx.SendMD("–ö–∞–∫–æ–µ —É—Å—Ç—Ä–æ–π—Å—Ç–≤–æ —É–¥–∞–ª–∏—Ç—å?", &telebot.ReplyMarkup{
		InlineKeyboard: common.FormatInlineButtons(buttons, 1),
	})
}

func (s *skill) delDeviceCallback(ctx app.Context, cb *telebot.Callback, args []string) {
	_ = ctx.Delete(cb.Message)
	id := args[0]
	var left []session.Device
	for _, device := range ctx.GetSettings().GetSystemDetails().ConnectedDevices {
		if device.ID != id {
			left = append(left, device)
		}
	}
	ctx.GetSettings().GetSystemDetails().ConnectedDevices = left
	if len(left) > 0 {
		s.delDevice(ctx, cb.Message)
	} else {
		s.devices(ctx, cb.Message)
	}
}
