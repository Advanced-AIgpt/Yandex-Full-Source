# autoclose

### Идея

Автоматическое закрытие тикетов ALICEASSESSORS: https://st.yandex-team.ru/ALICEQA-78

### Логика 
(примеры запросов для очереди QUASARSUP, поскольку на момент создания ALICE была пуста)
1. Спрашиваем количество закрытых тикетов из очереди ALICE
https://st-api.yandex-team.ru/v2/issues/_count?filter=queue:ALICE&filter=status:closed&filter=resolved:today()
- today потому что проще в языке запросов, а за один день их мало приходит. Частоту запуска раз в сутки 11 p.m. (до карантина)
2. Если кол-во > 50, то учесть пагинацию (50 - дефолтное значение) Но с учётом частоты обращений вряд ли. Мы не закрываем по 50 багов в день.
Если нет - пропускаем, переходим к шагу 3.
//2.1.// Если вдруг > 50, то считаем кол-во страниц и циклом проходим по всем, складывая результат в общую выборку.
3. Получаем резолюции и связанные тикеты для нашей выборки.
https://st-api.yandex-team.ru/v2/issues?filter=queue:ALICE&filter=status:closed&filter=resolved:today()&expand=links&fields=resolvedAt,resolution
resolvedAt потом можно убрать, это для человекочитаемости.
4. Запускаем цикл по полученному массиву. Для каждого закрытого тикета в ALICE идём в поля links
Внутри второй цикл по линкам.
Неудобно, что ключ очереди не указывается - пример ответа "links":[{"self":"https://st-api.yandex-team.ru/v2/issues/QUASARSUP-106/links/14188919","id":"14188919","display":"5b105aee36b07d001a3031e4 relates 5b507fdfd46bb7001bc93bf2"}]
Поэтому берём ссылку self.
//4.1.// Из ссылки получаем данные линкованного тикета, проверяем key и resolution. Если key~ALICEASSESSORS && resolution:null => переходим к поиску конфликтов. Если нет - переходим к следующему элементу цикла.
//4.2.// Конфликт может быть, когда к асессорскому тикету привязаны и открытые, и закрытые тикеты ALICE. Когда бот не может определить, нужно ли закрыть баг, то призывает в тикет кого-то из нас рандомно. Если конфликта нет => закрываем.
5. Для смены статусов используем POST-запрос с выполнением шага воркфлоу (close).
https://wiki.yandex-team.ru/tracker/api/issues/transitions-execute/
В data берём резолюцию исходного тикета ALICE (массив из первого цикла).
...
PROFIT

N.B. Случай связи один-ко-многим решаем просто: если тикет асессоров прилинкован к нашему, его надо закрыть. 
Мы линкуем только те тикеты, которые совпадают по багам. Если вместе слинкованы тикеты разных непохожих багов, то по-любому ошибка.
